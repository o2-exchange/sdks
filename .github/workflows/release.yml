name: Release

on:
  push:
    tags:
      - "python-v*"
      - "typescript-v*"
      - "rust-v*"

jobs:
  publish-python:
    name: Publish Python SDK
    if: startsWith(github.ref, 'refs/tags/python-v')
    runs-on: ubuntu-latest
    environment:
      name: deploy-pypi
      url: https://pypi.org/p/o2-sdk
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        working-directory: sdks/python
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
      - run: pip install build
      - run: python -m build
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: sdks/python/dist/

  publish-typescript:
    name: Publish TypeScript SDK
    if: startsWith(github.ref, 'refs/tags/typescript-v')
    runs-on: ubuntu-latest
    environment: deploy-npm
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        working-directory: sdks/typescript
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          registry-url: https://registry.npmjs.org
          cache: npm
          cache-dependency-path: sdks/typescript/package-lock.json
      - run: npm install -g npm@latest
      - run: npm ci
      - run: npm run build
      - run: npm publish --provenance --access public

  publish-rust:
    name: Publish Rust SDK
    if: startsWith(github.ref, 'refs/tags/rust-v')
    runs-on: ubuntu-latest
    environment: deploy-cargo
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        working-directory: sdks/rust
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: rust-lang/crates-io-auth-action@v1
        id: auth
      - run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
